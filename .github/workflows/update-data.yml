name: Update Country Data

on:
  schedule:
    # Run monthly on the 1st at 00:00 UTC
    - cron: '0 0 1 * *'
  
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update to perform'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - countries-only
          - groups-only
          - languages-only
          - validate-only

permissions:
  contents: write
  pull-requests: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install tsx globally
        run: npm install -g tsx
      
      - name: Update data
        run: |
          case "${{ inputs.update_type || 'all' }}" in
            "countries-only")
              tsx scripts/update-all.ts --countries-only
              ;;
            "groups-only")
              tsx scripts/update-all.ts --groups-only
              ;;
            "languages-only")
              tsx scripts/update-all.ts --languages-only
              ;;
            "validate-only")
              tsx scripts/validate-data.ts
              ;;
            *)
              tsx scripts/update-all.ts
              ;;
          esac
      
      - name: Run tests
        run: npm test
      
      - name: Run type check
        run: npm run build
      
      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Pull Request
        if: steps.changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Update country data
            
            - Updated country information from REST Countries API
            - Updated country group memberships
            - Updated language definitions
            - All data validation passed
            
            ü§ñ Generated with GitHub Actions
          title: 'Update country data - ${{ github.run_number }}'
          body: |
            ## üåç Country Data Update
            
            This pull request contains updated country data from reliable sources:
            
            ### Changes Made
            - **Countries**: Updated from REST Countries API
            - **Groups**: Updated political and economic group memberships
            - **Languages**: Updated language definitions and native names
            
            ### Data Sources
            - [REST Countries API](https://restcountries.com/) - Primary country data
            - Static data for political groups (EU, NATO, OECD, etc.)
            - ISO 639-1 language codes
            
            ### Validation
            - ‚úÖ All data validation tests passed
            - ‚úÖ TypeScript compilation successful
            - ‚úÖ Unit tests passed
            
            ### Statistics
            <!-- This will be filled by the script output -->
            
            ---
            
            *This PR was automatically generated by GitHub Actions*
          branch: update-country-data-${{ github.run_number }}
          delete-branch: true
          draft: false
          reviewers: |
            ${{ github.actor }}
      
      - name: Log results
        if: steps.changes.outputs.changes == 'false'
        run: |
          echo "‚ÑπÔ∏è No changes detected in country data"
          echo "Data is up to date"